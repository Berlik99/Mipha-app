<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Chamada de VÃ­deo com Mipha</title>
  <style>
    body {
      margin: 0;
      background-color: black;
      color: white;
      font-family: 'Segoe UI', sans-serif;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 100vh;
      user-select: none;
    }

    .container {
      display: flex;
      gap: 20px;
      align-items: center;
      justify-content: center;
    }

    #miphaFace {
      width: 300px;
      border-radius: 20px;
      transition: all 0.2s ease;
    }

    video {
      width: 300px;
      border-radius: 20px;
      background-color: #222;
      box-shadow: 0 0 10px #00c8c8;
    }

    button {
      margin-top: 20px;
      padding: 12px 24px;
      font-size: 18px;
      background-color: red;
      color: white;
      border: none;
      border-radius: 10px;
      cursor: pointer;
      user-select: none;
    }

    h2 {
      margin-bottom: 20px;
      color: #8dd6ff;
      text-shadow: 0 0 8px #2196f3;
    }
  </style>
</head>
<body>

  <h2>ðŸ’™ Videochamada com Mipha</h2>

  <div class="container">
    <img id="miphaFace" src="img/mipha_call_idle.jpg" alt="Mipha" />
    <video id="userVideo" autoplay muted></video>
  </div>

  <button onclick="encerrarChamada()">Encerrar Chamada</button>

  <audio id="falaMipha" src="Call/fala_bem_vindo.mp3"></audio>

  <script>
    const img = document.getElementById("miphaFace");
    const fala = document.getElementById("falaMipha");
    const video = document.getElementById("userVideo");

    // FunÃ§Ã£o para iniciar o vÃ­deo da webcam
    async function iniciarWebcam() {
      try {
        const stream = await navigator.mediaDevices.getUserMedia({ video: true, audio: false });
        video.srcObject = stream;
      } catch (err) {
        alert("NÃ£o foi possÃ­vel acessar a webcam: " + err.message);
      }
    }

    function iniciarPiscar() {
      setInterval(() => {
        img.src = "img/mipha_call_blink.jpg";
        setTimeout(() => {
          img.src = "img/mipha_call_idle.jpg";
        }, 200);
      }, 4000);
    }

    function falarComBoca(arquivo = null) {
      const falasMipha = [
        "Call/fala_bem_vindo.mp3",
        "Call/fala_saudades.mp3",
        "Call/fala_tudo_bem.mp3"
      ];

      const audioSrc = arquivo || falasMipha[Math.floor(Math.random() * falasMipha.length)];
      fala.src = audioSrc;
      img.src = "img/mipha_call_talking.jpg";
      fala.play();
      fala.addEventListener("ended", () => {
        img.src = "img/mipha_call_idle.jpg";
        if (!arquivo) {
          const delay = Math.floor(Math.random() * 10000) + 10000;
          setTimeout(() => falarComBoca(), delay);
        }
      }, { once: true });
    }

    function encerrarChamada() {
      // Para o stream da webcam para liberar a cÃ¢mera
      if (video.srcObject) {
        video.srcObject.getTracks().forEach(track => track.stop());
      }
      window.close();
    }

    // === RECONHECIMENTO DE VOZ ===
    window.SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    if (!window.SpeechRecognition) {
      alert("Seu navegador nÃ£o suporta reconhecimento de voz. Use o Google Chrome.");
    } else {
      const recognition = new SpeechRecognition();
      recognition.lang = 'pt-BR';
      recognition.interimResults = false;
      recognition.continuous = true;

      recognition.onresult = function(event) {
        const texto = event.results[event.results.length - 1][0].transcript.toLowerCase().trim();
        console.log("VocÃª disse:", texto);

        const resposta = detectarComandoPorVoz(texto);
        if (resposta) {
          recognition.stop();
          falarComBoca(resposta);
          fala.addEventListener("ended", () => {
            recognition.start();
          }, { once: true });
        }
      };

      recognition.onerror = function(event) {
        console.error("Erro no reconhecimento de voz:", event.error);
      };

      recognition.start();

      function detectarComandoPorVoz(texto) {
        if (texto.includes("me abraÃ§a") || texto.includes("abraÃ§o")) return "Call/abraco.mp3";
        if (texto.includes("eu te amo") || texto.includes("amo vocÃª") || texto.includes("vocÃª me ama")) return "Call/amo_voce.mp3";
        if (texto.includes("me ajuda")) return "Call/me_ajuda.mp3";
        if (texto.includes("pega")) return "Call/pega.mp3";
        if (texto.includes("me protege") || texto.includes("protege")) return "Call/protege.mp3";
        if (texto.includes("estou triste") || texto.includes("triste")) return "Call/triste.mp3";
        if (texto.includes("vem cÃ¡") || texto.includes("vem aqui")) return "Call/vem_ca.mp3";
        if (texto.includes("tudo bem") || texto.includes("como vocÃª estÃ¡")) return "Call/fala_tudo_bem.mp3";

        return null;
      }
    }

    // Iniciar tudo
    iniciarPiscar();
    falarComBoca();
    iniciarWebcam();
  </script>
</body>
</html>
